| задача                                                       | команды                                                      | комментарий                                                  |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| накатываем постгрес на все 3 терминала                       | sudo apt update && sudo apt upgrade -y && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc <br />sudo apt-key add - && sudo apt-get update && sudo apt-get -y install postgresql-14 |                                                              |
| на вм01, вм02 и вм03 выставляем параметр wal_level           | ALTER SYSTEM SET wal_level = logical;                        |                                                              |
| на вм01, вм02 и вм03 меняем в конфиге параметр listen_addresses перечисляя внутренние адреса 3 ВМ | sudo nano /etc/postgresql/14/main/postgresql.conf            |                                                              |
| на вм01, вм02 и вм03 меняем в конфиге  перечисляя внутренние адреса 3 ВМ | sudo nano /etc/postgresql/14/main/pg_hba.conf                |                                                              |
| перезапускаем кластеры на вм01, вм02, вм03                   | sudo pg_ctlcluster 14 main restart                           |                                                              |
| создаём на вм01-03 базу replicaDB с таблицами test и test2   | create database replicaDB;<br/> \c replicadb;<br/>create table test (fieldInt int);<br/>create table test2 (fieldInt int); |                                                              |
| задаём на ВМ01-03 пароль pas123 для учётки postgres          | \password                                                    |                                                              |
| на вм01 создаём публикацию для таблицы test                  | CREATE PUBLICATION test_pub FOR TABLE test;                  |                                                              |
| на вм02 создаём публикацию для таблицы test2                 | CREATE PUBLICATION test2_pub FOR TABLE test2;                |                                                              |
| подписываем вм01 на публикацию test2_pub на вм02             | CREATE SUBSCRIPTION test2_sub <br/>CONNECTION 'host=10.128.0.20 port=5432 user=postgres password=pas123 dbname=replicadb' <br/>PUBLICATION test2_pub WITH (copy_data = true); |                                                              |
| подписываем вм02 на публикацию test_pub на вм01              | CREATE SUBSCRIPTION test_sub <br/>CONNECTION 'host=10.128.0.19 port=5432 user=postgres password=pas123 dbname=replicadb' <br/>PUBLICATION test_pub WITH (copy_data = true); |                                                              |
| подписываем вм03 на публикации ВМ01 и ВМ02                   | CREATE SUBSCRIPTION test2_sub3 <br/>CONNECTION 'host=10.128.0.20 port=5432 user=postgres password=pas123 dbname=replicadb' <br/>PUBLICATION test2_pub WITH (copy_data = true);<br/>CREATE SUBSCRIPTION test_sub3 <br/>CONNECTION 'host=10.128.0.19 port=5432 user=postgres password=pas123 dbname=replicadb' <br/>PUBLICATION test_pub WITH (copy_data = true); |                                                              |
| Проверяем состояние подписок на виртуальных машинах          | состояниеподпискиSELECT * FROM pg_stat_subscription\gx       | так же проверил через вставки данных в таблицы test и test2, результаты чего попали на вм03 |
| если меняли на ВМ03 wal_level, то выставляем его в replica   | ALTER SYSTEM SET wal_level = replica;<br />затем перезапустим кластер на ВМ03: sudo pg_ctlcluster 14 main restart | так же убедимся что этот параметр аналогично настроен и на ВМ04 |
| на вм04 меняем в конфиге параметр listen_addresses указывая адрес ВМ03 | sudo nano /etc/postgresql/14/main/postgresql.conf            |                                                              |
| на вм4 меняем в конфиге указывая адрес ВМ03                  | sudo nano /etc/postgresql/14/main/pg_hba.conf                | обязательно поле БД прописываем replication                  |
| удаляем данные кластера на ВМ04                              | rm-rf/var/lib/postgresql/14/main                             |                                                              |
| копируем с ВМ03 БД на ВМ04                                   | зайти в консоль под учёткой postgres и выполнить:<br />pg_basebackup -h 10.128.0.21 -p 5432 -R -D /var/lib/postgresql/14/main | ключ -R готовит файл recovery.conf, при создании вручную по мануалам кластер не стартовал (были попытки до удаления данных кластера) |
| стартуем кластер ВМ04                                        | sudo pg_ctlcluster 14 main start                             |                                                              |
| проверяем состояние реплики на мастере                       | SELECT * FROM pg_stat_replication \gx                        |                                                              |
| проверяем состояние реплики на слейве                        | select * from pg_stat_wal_receiver \gx                       | дополнительно проверил что всё работает вставив на ВМ01 запись в таблицу test и увидел её на ВМ04 |

